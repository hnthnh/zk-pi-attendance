{% extends "base.html" %}

{% block title %}Employees | Attendance Sync{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<main class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap gap-3">
    <div>
      <h2 class="mb-0">Employee management</h2>
      <small class="text-muted">Total: {{ users|length }} employees</small>
    </div>
    <div class="d-flex flex-wrap align-items-end gap-2">
      <button class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
        Add employee
      </button>
      <form id="employeeFilter" class="row g-2 align-items-end">
        <div class="col-auto">
          <label class="form-label mb-1" for="employeeStartDate">Start</label>
          <input type="date" id="employeeStartDate" class="form-control form-control-sm">
        </div>
        <div class="col-auto">
          <label class="form-label mb-1" for="employeeEndDate">End</label>
          <input type="date" id="employeeEndDate" class="form-control form-control-sm">
        </div>
        <div class="col-auto d-flex gap-2">
          <button type="submit" class="btn btn-sm btn-primary">Apply</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="resetEmployeeDates">Reset</button>
        </div>
      </form>
    </div>
  </div>

  <div class="row g-4" id="employeeGrid"></div>
</main>

<div class="offcanvas offcanvas-end" tabindex="-1" id="employeeDetailDrawer" aria-labelledby="employeeDetailLabel">
  <div class="offcanvas-header">
    <div>
      <h5 class="offcanvas-title mb-0" id="employeeDetailLabel">Employee details</h5>
      <small class="text-muted" id="employeeDetailMeta"></small>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
  </div>
  <div class="offcanvas-body">
    <form id="employeeEditForm" class="mb-3">
      <input type="hidden" id="editEmployeeId">
      <div class="mb-3">
        <label class="form-label" for="editEmployeeName">Employee name</label>
        <input type="text" class="form-control" id="editEmployeeName" placeholder="Enter employee name">
      </div>
      <div class="mb-3">
        <label class="form-label" for="editEmployeeDepartment">Department</label>
        <input type="text" class="form-control" id="editEmployeeDepartment" placeholder="Enter department">
      </div>
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary flex-grow-1">Save changes</button>
        <button type="button" class="btn btn-outline-danger" id="deleteEmployeeBtn">Delete employee</button>
      </div>
    </form>

    <div class="row g-3 mini-stats text-center mb-3">
      <div class="col-6 col-md-3">
        <div class="stat-box">
          <span class="stat-label">Total hours</span>
          <span class="stat-value" id="detailTotalHours">0</span>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-box">
          <span class="stat-label">Make-up hours</span>
          <span class="stat-value" id="detailMakeupHours">0</span>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-box">
          <span class="stat-label">Late days</span>
          <span class="stat-value text-danger" id="detailLateDays">0</span>
        </div>
      </div>
      <div class="col-6 col-md-3">
        <div class="stat-box">
          <span class="stat-label">Days off</span>
          <span class="stat-value text-muted" id="detailOffDays">0</span>
        </div>
      </div>
    </div>

    <canvas id="detailChart" height="180" class="mb-4"></canvas>

    <div class="table-responsive">
      <table class="table table-hover align-middle" id="detailTable">
        <thead class="table-light">
          <tr>
            <th scope="col">Date</th>
            <th scope="col">Check In</th>
            <th scope="col">Check Out</th>
            <th scope="col">Working Hours</th>
            <th scope="col">Make-up (hrs)</th>
            <th scope="col">Total (hrs)</th>
            <th scope="col">Late (mins)</th>
            <th scope="col">Early (mins)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="addEmployeeForm">
      <div class="modal-header">
        <h5 class="modal-title" id="addEmployeeModalLabel">Add employee</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label" for="addUserId">Employee ID</label>
          <input type="number" min="1" step="1" class="form-control" id="addUserId" required>
        </div>
        <div class="mb-3">
          <label class="form-label" for="addEmployeeName">Employee name</label>
          <input type="text" class="form-control" id="addEmployeeName" placeholder="Enter employee name">
        </div>
        <div class="mb-3">
          <label class="form-label" for="addEmployeeDepartment">Department</label>
          <input type="text" class="form-control" id="addEmployeeDepartment" placeholder="Enter department">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" class="btn btn-primary">Add</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  const initialUsers = {{ users|tojson() }};
  let usersData = initialUsers.map((user) => ({
    user_id: Number(user.user_id),
    name: user.name || '',
    department: user.department || '',
  }));
  let currentSummaryRows = [];
  let currentDetailRows = [];
  let currentDetailUserId = null;

  const employeeGrid = document.getElementById('employeeGrid');
  const employeeFilter = document.getElementById('employeeFilter');
  const startInput = document.getElementById('employeeStartDate');
  const endInput = document.getElementById('employeeEndDate');
  const resetDatesBtn = document.getElementById('resetEmployeeDates');

  const detailDrawerEl = document.getElementById('employeeDetailDrawer');
  const detailDrawer = new bootstrap.Offcanvas(detailDrawerEl);
  const detailLabel = document.getElementById('employeeDetailLabel');
  const detailMeta = document.getElementById('employeeDetailMeta');
  const editForm = document.getElementById('employeeEditForm');
  const editEmployeeIdInput = document.getElementById('editEmployeeId');
  const editNameInput = document.getElementById('editEmployeeName');
  const editDepartmentInput = document.getElementById('editEmployeeDepartment');
  const deleteEmployeeBtn = document.getElementById('deleteEmployeeBtn');

  const detailTotalHours = document.getElementById('detailTotalHours');
  const detailMakeupHours = document.getElementById('detailMakeupHours');
  const detailLateDays = document.getElementById('detailLateDays');
  const detailOffDays = document.getElementById('detailOffDays');
  const detailTableBody = document.querySelector('#detailTable tbody');
  const detailChartCtx = document.getElementById('detailChart').getContext('2d');
  let detailChart = null;

  const addEmployeeModalEl = document.getElementById('addEmployeeModal');
  const addEmployeeModal = new bootstrap.Modal(addEmployeeModalEl);
  const addEmployeeForm = document.getElementById('addEmployeeForm');
  const addUserIdInput = document.getElementById('addUserId');
  const addNameInput = document.getElementById('addEmployeeName');
  const addDepartmentInput = document.getElementById('addEmployeeDepartment');

  const formatHours = (value) => {
    if (value === null || value === undefined) return '';
    const num = Number(value);
    if (Number.isNaN(num)) return '';
    return num.toFixed(2);
  };

  const formatTime = (value) => {
    if (!value) return '';
    const dt = new Date(value);
    if (Number.isNaN(dt.getTime())) {
      const match = value.match(/T(\d{2}:\d{2})/);
      return match ? match[1] : value;
    }
    return dt.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  };

  const sortUsers = () => {
    usersData.sort((a, b) => a.user_id - b.user_id);
  };

  sortUsers();

  const getUserById = (userId) => usersData.find((user) => user.user_id === userId) || null;

  const buildParams = () => {
    const params = new URLSearchParams();
    if (startInput.value) params.append('start_date', startInput.value);
    if (endInput.value) params.append('end_date', endInput.value);
    return params;
  };

  const fetchSummary = async (params) => {
    const response = await fetch(`/summary?${params.toString()}`);
    if (!response.ok) {
      const payload = await response.json().catch(() => ({}));
      throw new Error(payload.message || 'Unable to load data');
    }
    return response.json();
  };

  const groupByUser = (rows) => {
    const grouped = {};
    rows.forEach((row) => {
      if (!grouped[row.user_id]) grouped[row.user_id] = [];
      grouped[row.user_id].push(row);
    });
    return grouped;
  };

  const computeStats = (rows) => {
    let workingDays = 0;
    let lateDays = 0;
    let totalHours = 0;
    let makeupHours = 0;
    rows.forEach((row) => {
      if (!row.is_day_off) workingDays += 1;
      if (!row.is_day_off && Number(row.late_mins) > 0) lateDays += 1;
      totalHours += Number(row.total_hours ?? row.working_hours ?? 0) || 0;
      makeupHours += Number(row.makeup_hours || 0) || 0;
    });
    return { workingDays, lateDays, totalHours, makeupHours };
  };

  const renderCards = (summaryRows) => {
    employeeGrid.innerHTML = '';
    if (!usersData.length) {
      const emptyCol = document.createElement('div');
      emptyCol.className = 'col-12';
      emptyCol.innerHTML = '<div class="alert alert-warning mb-0">No employees yet. Add a new employee to get started.</div>';
      employeeGrid.appendChild(emptyCol);
      return;
    }

    const summaryByUser = groupByUser(summaryRows);
    const fragment = document.createDocumentFragment();

    usersData.forEach((user) => {
      const rows = summaryByUser[user.user_id] || [];
      const { workingDays, lateDays, totalHours, makeupHours } = computeStats(rows);

      const col = document.createElement('div');
      col.className = 'col-xl-4 col-lg-6';
      col.innerHTML = `
        <div class="card shadow-sm h-100 employee-card" data-user-id="${user.user_id}">
          <div class="card-header bg-white d-flex justify-content-between align-items-center">
            <div>
              <h5 class="card-title mb-0">${user.name || `User ${user.user_id}`}</h5>
              <small class="text-muted">ID: ${user.user_id}${user.department ? ` • ${user.department}` : ''}</small>
            </div>
            <button class="btn btn-outline-primary btn-sm view-detail" data-user-id="${user.user_id}">Details</button>
          </div>
          <div class="card-body">
            <div class="mini-stats row g-3 text-center">
              <div class="col-6">
                <div class="stat-box">
                  <span class="stat-label">Working days</span>
                  <span class="stat-value text-success">${workingDays}</span>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-box">
                  <span class="stat-label">Late days</span>
                  <span class="stat-value text-danger">${lateDays}</span>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-box">
                  <span class="stat-label">Total hours</span>
                  <span class="stat-value">${formatHours(totalHours)}</span>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-box">
                  <span class="stat-label">Make-up hours</span>
                  <span class="stat-value">${formatHours(makeupHours)}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
      fragment.appendChild(col);
    });

    employeeGrid.appendChild(fragment);
  };

  const showEmployeeDetail = (user, rows, open = false) => {
    const sortedRows = rows.slice().sort((a, b) => a.date.localeCompare(b.date));
    currentDetailRows = sortedRows;
    currentDetailUserId = user.user_id;

    detailLabel.textContent = user.name || `User ${user.user_id}`;
    detailMeta.textContent = `ID: ${user.user_id}${user.department ? ` • ${user.department}` : ''}`;
    editEmployeeIdInput.value = user.user_id;
    editNameInput.value = user.name || '';
    editDepartmentInput.value = user.department || '';

    const { workingDays, lateDays, totalHours, makeupHours } = computeStats(sortedRows);
    const offDays = sortedRows.filter((row) => row.is_day_off).length;
    const onTimeDays = sortedRows.filter((row) => !row.is_day_off && Number(row.late_mins) === 0).length;

    detailTotalHours.textContent = formatHours(totalHours);
    detailMakeupHours.textContent = formatHours(makeupHours);
    detailLateDays.textContent = lateDays;
    detailOffDays.textContent = offDays;

    detailTableBody.innerHTML = '';
    if (!sortedRows.length) {
      const emptyRow = document.createElement('tr');
      emptyRow.innerHTML = '<td colspan="8" class="text-center text-muted">No attendance data available</td>';
      detailTableBody.appendChild(emptyRow);
    } else {
      sortedRows.forEach((row) => {
        const tr = document.createElement('tr');
        const cells = [
          row.date,
          row.check_in ? formatTime(row.check_in) : '<span class="missing-entry">---</span>',
          row.check_out ? formatTime(row.check_out) : '<span class="missing-entry">---</span>',
          formatHours(row.working_hours),
          formatHours(row.makeup_hours),
          formatHours(row.total_hours),
          row.late_mins,
          row.early_leave_mins,
        ];
        cells.forEach((content) => {
          const td = document.createElement('td');
          td.innerHTML = content;
          tr.appendChild(td);
        });
        detailTableBody.appendChild(tr);
      });
    }

    const chartData = [onTimeDays, lateDays, offDays];
    if (!detailChart) {
      detailChart = new Chart(detailChartCtx, {
        type: 'pie',
        data: {
          labels: ['On time', 'Late', 'Off'],
          datasets: [{
            data: chartData,
            backgroundColor: ['#198754', '#dc3545', '#6c757d'],
          }],
        },
        options: {
          plugins: { legend: { position: 'bottom' } },
        },
      });
    } else {
      detailChart.data.datasets[0].data = chartData;
      detailChart.update();
    }

    if (open) {
      detailDrawer.show();
    }
  };

  const loadEmployees = async () => {
    try {
      const params = buildParams();
      const data = await fetchSummary(params);
      currentSummaryRows = data;
      renderCards(currentSummaryRows);
    } catch (error) {
      alert(error.message);
    }
  };

  employeeGrid.addEventListener('click', async (event) => {
    const button = event.target.closest('.view-detail');
    if (!button) return;
    const userId = Number(button.dataset.userId);
    const user = getUserById(userId);
    if (!user) {
      alert('Employee information not found.');
      return;
    }
    try {
      const params = buildParams();
      params.append('user_id', userId);
      const rows = await fetchSummary(params);
      showEmployeeDetail(user, rows, true);
    } catch (error) {
      alert(error.message);
    }
  });

  employeeFilter.addEventListener('submit', (event) => {
    event.preventDefault();
    loadEmployees();
  });

  resetDatesBtn.addEventListener('click', () => {
    startInput.value = '';
    endInput.value = '';
    loadEmployees();
  });

  addEmployeeForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    const userId = Number(addUserIdInput.value);
    if (!Number.isInteger(userId) || userId <= 0) {
      alert('Employee ID is invalid.');
      return;
    }
    const payload = {
      user_id: userId,
      name: addNameInput.value.trim() || null,
      department: addDepartmentInput.value.trim() || null,
    };
    try {
      const response = await fetch('/api/users', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const result = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(result.message || 'Unable to add employee');
      }
      usersData.push({
        user_id: result.data.user_id,
        name: result.data.name || '',
        department: result.data.department || '',
      });
      sortUsers();
      addEmployeeModal.hide();
      addEmployeeForm.reset();
      renderCards(currentSummaryRows);
      alert('Employee added successfully.');
    } catch (error) {
      alert(error.message);
    }
  });

  editForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    if (currentDetailUserId === null) return;
    const payload = {
      name: editNameInput.value.trim() || null,
      department: editDepartmentInput.value.trim() || null,
    };
    try {
      const response = await fetch(`/api/users/${currentDetailUserId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const result = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(result.message || 'Unable to update employee');
      }
      const user = getUserById(currentDetailUserId);
      if (user) {
        user.name = result.data.name || '';
        user.department = result.data.department || '';
      }
      currentSummaryRows = currentSummaryRows.map((row) =>
        row.user_id === currentDetailUserId
          ? { ...row, name: result.data.name, department: result.data.department }
          : row
      );
      renderCards(currentSummaryRows);
      if (user) {
        showEmployeeDetail(user, currentDetailRows, false);
      }
      alert('Employee information updated.');
    } catch (error) {
      alert(error.message);
    }
  });

  deleteEmployeeBtn.addEventListener('click', async () => {
    if (currentDetailUserId === null) return;
    if (!confirm('Are you sure you want to delete this employee?')) return;
    try {
      const response = await fetch(`/api/users/${currentDetailUserId}`, { method: 'DELETE' });
      const result = await response.json().catch(() => ({}));
      if (!response.ok) {
        throw new Error(result.message || 'Unable to delete employee');
      }
      usersData = usersData.filter((user) => user.user_id !== currentDetailUserId);
      currentSummaryRows = currentSummaryRows.filter((row) => row.user_id !== currentDetailUserId);
      renderCards(currentSummaryRows);
      detailDrawer.hide();
      alert('Employee deleted.');
    } catch (error) {
      alert(error.message);
    }
  });

  detailDrawerEl.addEventListener('hidden.bs.offcanvas', () => {
    currentDetailUserId = null;
    currentDetailRows = [];
  });

  document.addEventListener('DOMContentLoaded', () => {
    loadEmployees();
  });
</script>
{% endblock %}
