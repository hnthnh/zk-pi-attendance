{% extends "base.html" %}

{% block title %}K·∫øt n·ªëi thi·∫øt b·ªã | MayChamCong{% endblock %}

{% block content %}
<main class="container py-5">
  <div class="row g-4 align-items-stretch">
    <div class="col-12">
      <div class="bg-dark text-white rounded-4 p-4 p-md-5 shadow-sm d-flex flex-column flex-md-row align-items-center justify-content-between">
        <div>
          <h1 class="display-6 fw-bold mb-2">K·∫øt n·ªëi thi·∫øt b·ªã ZKTeco</h1>
          <p class="mb-0 text-white-50">Ho√†n t·∫•t b∆∞·ªõc k·∫øt n·ªëi tr∆∞·ªõc khi truy c·∫≠p dashboard. Ki·ªÉm tra, th·ª≠ nghi·ªám v√† l∆∞u c·∫•u h√¨nh thi·∫øt b·ªã c·ªßa b·∫°n trong v√†i gi√¢y.</p>
        </div>
        <div class="mt-3 mt-md-0 d-flex gap-2">
          <button id="refreshDevicesBtn" class="btn btn-outline-light btn-lg">
            <span class="me-2" aria-hidden="true">üîÑ</span> T√¨m thi·∫øt b·ªã ƒë√£ l∆∞u
          </button>
          <button id="disconnectBtn" class="btn btn-outline-light btn-lg d-none">
            <span class="me-2" aria-hidden="true">üßπ</span> Ng·∫Øt k·∫øt n·ªëi
          </button>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-lg border-0 h-100">
        <div class="card-body p-4">
          <h2 class="h4 mb-3">Th√¥ng tin thi·∫øt b·ªã</h2>
          <p class="text-muted">Nh·∫≠p ƒë·ªãa ch·ªâ IP v√† c·ªïng k·∫øt n·ªëi c·ªßa m√°y ch·∫•m c√¥ng, sau ƒë√≥ th·ª≠ k·∫øt n·ªëi ƒë·ªÉ ƒë·∫£m b·∫£o th√¥ng s·ªë ch√≠nh x√°c.</p>
          <div id="connectionAlert" class="alert d-none" role="alert"></div>
          <form id="connectionForm" class="row g-3">
            <div class="col-12">
              <label class="form-label" for="deviceHost">ƒê·ªãa ch·ªâ IP <span class="text-danger">*</span></label>
              <input type="text" id="deviceHost" name="host" class="form-control form-control-lg" placeholder="V√≠ d·ª•: 192.168.0.201" value="{{ active_config.host if active_config else '' }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="devicePort">C·ªïng <span class="text-danger">*</span></label>
              <input type="number" id="devicePort" name="port" class="form-control form-control-lg" placeholder="4370" value="{{ active_config.port if active_config else 4370 }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="devicePassword">M·∫≠t kh·∫©u (n·∫øu c√≥)</label>
              <input type="number" id="devicePassword" name="password" class="form-control form-control-lg" placeholder="0" value="{{ active_config.password if active_config else 0 }}">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="deviceTimeout">Timeout (gi√¢y)</label>
              <input type="number" id="deviceTimeout" name="timeout" class="form-control form-control-lg" placeholder="5" value="{{ active_config.timeout if active_config else 5 }}">
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="forceUdpSwitch" {% if active_config and active_config.force_udp %}checked{% endif %}>
                <label class="form-check-label" for="forceUdpSwitch">Bu·ªôc s·ª≠ d·ª•ng UDP</label>
              </div>
            </div>
            <div class="col-12 d-grid gap-3 d-md-flex">
              <button type="button" id="testButton" class="btn btn-outline-primary btn-lg flex-fill">
                <span class="me-2" aria-hidden="true">üß™</span> Test k·∫øt n·ªëi
              </button>
              <button type="button" id="connectButton" class="btn btn-primary btn-lg flex-fill" disabled>
                <span class="me-2" aria-hidden="true">üîå</span> K·∫øt n·ªëi v√† ti·∫øp t·ª•c
              </button>
            </div>
          </form>
          <div id="testResult" class="card bg-light border-0 mt-4 d-none">
            <div class="card-body">
              <h3 class="h6 text-uppercase text-muted mb-3">Th√¥ng tin thi·∫øt b·ªã</h3>
              <dl class="row mb-0">
                <dt class="col-sm-4 text-muted">Serial</dt>
                <dd class="col-sm-8" id="resultSerial">-</dd>
                <dt class="col-sm-4 text-muted">Firmware</dt>
                <dd class="col-sm-8" id="resultFirmware">-</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-body p-4">
          <h2 class="h5 mb-3">Thi·∫øt b·ªã ƒë√£ l∆∞u</h2>
          <p class="text-muted">Ch·ªçn nhanh c·∫•u h√¨nh ƒë√£ l∆∞u tr∆∞·ªõc ƒë√≥ ƒë·ªÉ ƒëi·ªÅn v√†o bi·ªÉu m·∫´u.</p>
          <div id="savedDevices" class="list-group list-group-flush border rounded-3"></div>
          <div id="noDevicesState" class="text-center text-muted py-4{% if devices %} d-none{% endif %}">
            <p class="mb-0">Ch∆∞a c√≥ thi·∫øt b·ªã n√†o. H√£y th√™m ·ªü trang "Thi·∫øt b·ªã" ho·∫∑c l∆∞u c·∫•u h√¨nh m·ªõi.</p>
          </div>
        </div>
      </div>
      <div class="card shadow-lg border-0">
        <div class="card-body p-4">
          <h2 class="h5 mb-3">Supported models</h2>
          <p class="text-muted">C√°c d√≤ng m√°y ZKTeco ƒë∆∞·ª£c ki·ªÉm nghi·ªám t∆∞∆°ng th√≠ch v·ªõi h·ªá th·ªëng.</p>
          <div class="row g-3">
            {% for model in supported_models %}
            <div class="col-sm-6">
              <div class="border rounded-3 p-3 h-100 d-flex align-items-center justify-content-between bg-body-tertiary">
                <span class="fw-medium">{{ model }}</span>
                <span aria-hidden="true">‚úÖ</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script>
  const alertBox = document.getElementById('connectionAlert');
  const testButton = document.getElementById('testButton');
  const connectButton = document.getElementById('connectButton');
  const disconnectButton = document.getElementById('disconnectBtn');
  const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
  const savedDevicesContainer = document.getElementById('savedDevices');
  const noDevicesState = document.getElementById('noDevicesState');
  const form = document.getElementById('connectionForm');
  const hostInput = document.getElementById('deviceHost');
  const portInput = document.getElementById('devicePort');
  const passwordInput = document.getElementById('devicePassword');
  const timeoutInput = document.getElementById('deviceTimeout');
  const forceUdpSwitch = document.getElementById('forceUdpSwitch');
  const serialField = document.getElementById('resultSerial');
  const firmwareField = document.getElementById('resultFirmware');
  const resultCard = document.getElementById('testResult');

  let lastTestSuccess = false;

  const showAlert = (message, type = 'info') => {
    alertBox.textContent = message;
    alertBox.className = `alert alert-${type}`;
    alertBox.classList.remove('d-none');
  };

  const hideAlert = () => {
    alertBox.className = 'alert d-none';
  };

  const getFormData = () => {
    const formData = new FormData(form);
    return {
      host: formData.get('host')?.trim(),
      port: formData.get('port'),
      password: formData.get('password'),
      timeout: formData.get('timeout'),
      force_udp: forceUdpSwitch.checked,
    };
  };

  const populateForm = (device) => {
    hostInput.value = device.ip || '';
    portInput.value = device.port || 4370;
    passwordInput.value = device.password || 0;
    timeoutInput.value = device.timeout || 5;
    forceUdpSwitch.checked = Boolean(device.force_udp);
    hideAlert();
    resultCard.classList.add('d-none');
    connectButton.disabled = true;
    lastTestSuccess = false;
  };

  const renderDevices = (devices = []) => {
    savedDevicesContainer.innerHTML = '';
    if (!devices.length) {
      noDevicesState.classList.remove('d-none');
      return;
    }

    noDevicesState.classList.add('d-none');
    devices.forEach((device) => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
      item.innerHTML = `
        <div>
          <div class="fw-semibold">${device.name}</div>
          <small class="text-muted">${device.ip || 'Kh√¥ng c√≥ IP'} ‚Ä¢ Port ${device.port || '-'}</small>
        </div>
        <span class="text-primary fw-semibold">Ch·ªçn</span>
      `;
      item.addEventListener('click', () => populateForm(device));
      savedDevicesContainer.appendChild(item);
    });
  };

  const loadSavedDevices = async () => {
    try {
      refreshDevicesBtn.classList.add('disabled');
      refreshDevicesBtn.textContent = 'ƒêang t√¨m...';
      const response = await fetch('{{ url_for("api_devices") }}');
      if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch thi·∫øt b·ªã.');
      const data = await response.json();
      renderDevices(data.devices || []);
    } catch (error) {
      showAlert(error.message, 'danger');
    } finally {
      refreshDevicesBtn.classList.remove('disabled');
      refreshDevicesBtn.textContent = 'üîÑ T√¨m thi·∫øt b·ªã ƒë√£ l∆∞u';
    }
  };

  const loadCurrentConnection = async () => {
    try {
      const response = await fetch('{{ url_for("api_current_device") }}');
      if (!response.ok) return;
      const data = await response.json();
      if (data.connected) {
        disconnectButton.classList.remove('d-none');
      }
    } catch (error) {
      console.error(error);
    }
  };

  testButton.addEventListener('click', async () => {
    hideAlert();
    const payload = getFormData();
    if (!payload.host) {
      showAlert('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ IP c·ªßa thi·∫øt b·ªã.', 'warning');
      return;
    }
    testButton.disabled = true;
    testButton.textContent = 'ƒêang ki·ªÉm tra...';
    connectButton.disabled = true;
    resultCard.classList.add('d-none');
    try {
      const response = await fetch('{{ url_for("api_test_device") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json();
      if (!response.ok || data.status === 'error') {
        throw new Error(data.message || 'Kh√¥ng th·ªÉ test k·∫øt n·ªëi.');
      }
      showAlert('K·∫øt n·ªëi th√†nh c√¥ng! B·∫°n c√≥ th·ªÉ l∆∞u c·∫•u h√¨nh.', 'success');
      resultCard.classList.remove('d-none');
      serialField.textContent = data.serial || '-';
      firmwareField.textContent = data.firmware || '-';
      connectButton.disabled = false;
      lastTestSuccess = true;
    } catch (error) {
      showAlert(error.message, 'danger');
      lastTestSuccess = false;
    } finally {
      testButton.disabled = false;
      testButton.textContent = 'üß™ Test k·∫øt n·ªëi';
    }
  });

  connectButton.addEventListener('click', async () => {
    if (!lastTestSuccess) {
      showAlert('Vui l√≤ng test k·∫øt n·ªëi tr∆∞·ªõc khi l∆∞u.', 'warning');
      return;
    }

    const payload = getFormData();
    connectButton.disabled = true;
    connectButton.textContent = 'ƒêang k·∫øt n·ªëi...';
    try {
      const response = await fetch('{{ url_for("api_connect_device") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json();
      if (!response.ok || data.status === 'error') {
        throw new Error(data.message || 'Kh√¥ng th·ªÉ k·∫øt n·ªëi thi·∫øt b·ªã.');
      }
      showAlert('ƒê√£ l∆∞u c·∫•u h√¨nh! ƒêang chuy·ªÉn ƒë·∫øn dashboard...', 'success');
      setTimeout(() => window.location.href = '{{ url_for("index") }}', 1200);
    } catch (error) {
      showAlert(error.message, 'danger');
    } finally {
      connectButton.disabled = false;
      connectButton.textContent = 'üîå K·∫øt n·ªëi v√† ti·∫øp t·ª•c';
    }
  });

  disconnectButton.addEventListener('click', async () => {
    try {
      disconnectButton.disabled = true;
      const response = await fetch('{{ url_for("api_disconnect_device") }}', { method: 'POST' });
      if (!response.ok) throw new Error('Kh√¥ng th·ªÉ ng·∫Øt k·∫øt n·ªëi hi·ªán t·∫°i.');
      showAlert('ƒê√£ ng·∫Øt k·∫øt n·ªëi. Vui l√≤ng c·∫•u h√¨nh l·∫°i thi·∫øt b·ªã.', 'info');
      disconnectButton.classList.add('d-none');
      lastTestSuccess = false;
      connectButton.disabled = true;
      resultCard.classList.add('d-none');
    } catch (error) {
      showAlert(error.message, 'danger');
    } finally {
      disconnectButton.disabled = false;
    }
  });

  refreshDevicesBtn.addEventListener('click', loadSavedDevices);

  document.addEventListener('DOMContentLoaded', () => {
    {% if devices %}
      renderDevices({{ devices|tojson }});
    {% endif %}
    loadCurrentConnection();
  });
</script>
{% endblock %}
