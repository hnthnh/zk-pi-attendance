{% extends "base.html" %}

{% block title %}Connect Device | Attendance Sync{% endblock %}

{% block content %}
<main class="container py-5">
  <div class="row g-4 align-items-stretch">
    <div class="col-12">
      <div class="bg-dark text-white rounded-4 p-4 p-md-5 shadow-sm d-flex flex-column flex-md-row align-items-center justify-content-between">
        <div>
          <h1 class="display-6 fw-bold mb-2">Connect your ZKTeco terminal</h1>
          <p class="mb-0 text-white-50">Complete this setup before visiting the dashboard. Discover, test, and save your device configuration in seconds.</p>
        </div>
        <div class="mt-3 mt-md-0 d-flex gap-2">
          <button id="refreshDevicesBtn" class="btn btn-outline-light btn-lg">
            <span class="me-2" aria-hidden="true">ðŸ”„</span> Load saved devices
          </button>
          <button id="disconnectBtn" class="btn btn-outline-light btn-lg d-none">
            <span class="me-2" aria-hidden="true">ðŸ§¹</span> Disconnect
          </button>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-lg border-0 h-100">
        <div class="card-body p-4">
          <h2 class="h4 mb-3">Device details</h2>
          <p class="text-muted">Enter the IP address and connection port, then run a test to ensure the configuration is correct.</p>
          <div id="connectionAlert" class="alert d-none" role="alert"></div>
          <form id="connectionForm" class="row g-3">
            <div class="col-12">
              <label class="form-label" for="deviceHost">IP address <span class="text-danger">*</span></label>
              <input type="text" id="deviceHost" name="host" class="form-control form-control-lg" placeholder="Example: 192.168.0.201" value="{{ active_config.host if active_config else '' }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="devicePort">Port <span class="text-danger">*</span></label>
              <input type="number" id="devicePort" name="port" class="form-control form-control-lg" placeholder="4370" value="{{ active_config.port if active_config else 4370 }}" required>
            </div>
            <div class="col-md-6">
              <label class="form-label" for="devicePassword">Password (optional)</label>
              <input type="number" id="devicePassword" name="password" class="form-control form-control-lg" placeholder="0" value="{{ active_config.password if active_config else 0 }}">
            </div>
            <div class="col-md-6">
              <label class="form-label" for="deviceTimeout">Timeout (seconds)</label>
              <input type="number" id="deviceTimeout" name="timeout" class="form-control form-control-lg" placeholder="5" value="{{ active_config.timeout if active_config else 5 }}">
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="forceUdpSwitch" {% if active_config and active_config.force_udp %}checked{% endif %}>
                <label class="form-check-label" for="forceUdpSwitch">Force UDP</label>
              </div>
            </div>
            <div class="col-12 d-grid gap-3 d-md-flex">
              <button type="button" id="testButton" class="btn btn-outline-primary btn-lg flex-fill">
                <span class="me-2" aria-hidden="true">ðŸ§ª</span> Test connection
              </button>
              <button type="button" id="connectButton" class="btn btn-primary btn-lg flex-fill" disabled>
                <span class="me-2" aria-hidden="true">ðŸ”Œ</span> Connect & continue
              </button>
            </div>
          </form>
          <div id="testResult" class="card bg-light border-0 mt-4 d-none">
            <div class="card-body">
              <h3 class="h6 text-uppercase text-muted mb-3">Device information</h3>
              <dl class="row mb-0">
                <dt class="col-sm-4 text-muted">Serial</dt>
                <dd class="col-sm-8" id="resultSerial">-</dd>
                <dt class="col-sm-4 text-muted">Firmware</dt>
                <dd class="col-sm-8" id="resultFirmware">-</dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6">
      <div class="card shadow-lg border-0 mb-4">
        <div class="card-body p-4">
          <h2 class="h5 mb-3">Saved devices</h2>
          <p class="text-muted">Pick a previously stored configuration to auto-fill the form.</p>
          <div id="savedDevices" class="list-group list-group-flush border rounded-3"></div>
          <div id="noDevicesState" class="text-center text-muted py-4{% if devices %} d-none{% endif %}">
            <p class="mb-0">No saved devices yet. Add one on the Devices page or save a new configuration here.</p>
          </div>
        </div>
      </div>
      <div class="card shadow-lg border-0">
        <div class="card-body p-4">
          <h2 class="h5 mb-3">Supported models</h2>
          <p class="text-muted">ZKTeco models verified to work smoothly with this project.</p>
          <div class="row g-3">
            {% for model in supported_models %}
            <div class="col-sm-6">
              <div class="border rounded-3 p-3 h-100 d-flex align-items-center justify-content-between bg-body-tertiary">
                <span class="fw-medium">{{ model }}</span>
                <span aria-hidden="true">âœ…</span>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</main>
{% endblock %}

{% block scripts %}
<script>
  const alertBox = document.getElementById('connectionAlert');
  const testButton = document.getElementById('testButton');
  const connectButton = document.getElementById('connectButton');
  const disconnectButton = document.getElementById('disconnectBtn');
  const refreshDevicesBtn = document.getElementById('refreshDevicesBtn');
  const savedDevicesContainer = document.getElementById('savedDevices');
  const noDevicesState = document.getElementById('noDevicesState');
  const form = document.getElementById('connectionForm');
  const hostInput = document.getElementById('deviceHost');
  const portInput = document.getElementById('devicePort');
  const passwordInput = document.getElementById('devicePassword');
  const timeoutInput = document.getElementById('deviceTimeout');
  const forceUdpSwitch = document.getElementById('forceUdpSwitch');
  const serialField = document.getElementById('resultSerial');
  const firmwareField = document.getElementById('resultFirmware');
  const resultCard = document.getElementById('testResult');

  let lastTestSuccess = false;

  const showAlert = (message, type = 'info') => {
    alertBox.textContent = message;
    alertBox.className = `alert alert-${type}`;
    alertBox.classList.remove('d-none');
  };

  const hideAlert = () => {
    alertBox.className = 'alert d-none';
  };

  const getFormData = () => {
    const formData = new FormData(form);
    return {
      host: formData.get('host')?.trim(),
      port: formData.get('port'),
      password: formData.get('password'),
      timeout: formData.get('timeout'),
      force_udp: forceUdpSwitch.checked,
    };
  };

  const populateForm = (device) => {
    hostInput.value = device.ip || '';
    portInput.value = device.port || 4370;
    passwordInput.value = device.password || 0;
    timeoutInput.value = device.timeout || 5;
    forceUdpSwitch.checked = Boolean(device.force_udp);
    hideAlert();
    resultCard.classList.add('d-none');
    connectButton.disabled = true;
    lastTestSuccess = false;
  };

  const renderDevices = (devices = []) => {
    savedDevicesContainer.innerHTML = '';
    if (!devices.length) {
      noDevicesState.classList.remove('d-none');
      return;
    }

    noDevicesState.classList.add('d-none');
    devices.forEach((device) => {
      const item = document.createElement('button');
      item.type = 'button';
      item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
      item.innerHTML = `
        <div>
          <div class="fw-semibold">${device.name}</div>
          <small class="text-muted">${device.ip || 'No IP set'} â€¢ Port ${device.port || '-'}</small>
        </div>
        <span class="text-primary fw-semibold">Select</span>
      `;
      item.addEventListener('click', () => populateForm(device));
      savedDevicesContainer.appendChild(item);
    });
  };

  const loadSavedDevices = async () => {
    try {
      refreshDevicesBtn.classList.add('disabled');
      refreshDevicesBtn.textContent = 'Searching...';
      const response = await fetch('{{ url_for("api_devices") }}');
      if (!response.ok) throw new Error('Unable to load devices.');
      const data = await response.json();
      renderDevices(data.devices || []);
    } catch (error) {
      showAlert(error.message, 'danger');
    } finally {
      refreshDevicesBtn.classList.remove('disabled');
      refreshDevicesBtn.textContent = 'ðŸ”„ Load saved devices';
    }
  };

  const loadCurrentConnection = async () => {
    try {
      const response = await fetch('{{ url_for("api_current_device") }}');
      if (!response.ok) return;
      const data = await response.json();
      if (data.connected) {
        disconnectButton.classList.remove('d-none');
      }
    } catch (error) {
      console.error(error);
    }
  };

  testButton.addEventListener('click', async () => {
    hideAlert();
    const payload = getFormData();
    if (!payload.host) {
      showAlert('Please enter the device IP address.', 'warning');
      return;
    }
    testButton.disabled = true;
    testButton.textContent = 'Testing...';
    connectButton.disabled = true;
    resultCard.classList.add('d-none');
    try {
      const response = await fetch('{{ url_for("api_test_device") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json();
      if (!response.ok || data.status === 'error') {
        throw new Error(data.message || 'Unable to test the connection.');
      }
      showAlert('Connection successful! You can now save the configuration.', 'success');
      resultCard.classList.remove('d-none');
      serialField.textContent = data.serial || '-';
      firmwareField.textContent = data.firmware || '-';
      connectButton.disabled = false;
      lastTestSuccess = true;
    } catch (error) {
      showAlert(error.message, 'danger');
      lastTestSuccess = false;
    } finally {
      testButton.disabled = false;
      testButton.textContent = 'ðŸ§ª Test connection';
    }
  });

  connectButton.addEventListener('click', async () => {
    if (!lastTestSuccess) {
      showAlert('Please run a connection test before saving.', 'warning');
      return;
    }

    const payload = getFormData();
    connectButton.disabled = true;
    connectButton.textContent = 'Connecting...';
    try {
      const response = await fetch('{{ url_for("api_connect_device") }}', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await response.json();
      if (!response.ok || data.status === 'error') {
        throw new Error(data.message || 'Unable to connect to the device.');
      }
      showAlert('Configuration saved! Redirecting to the dashboard...', 'success');
      setTimeout(() => window.location.href = '{{ url_for("index") }}', 1200);
    } catch (error) {
      showAlert(error.message, 'danger');
    } finally {
      connectButton.disabled = false;
      connectButton.textContent = 'ðŸ”Œ Connect & continue';
    }
  });

  disconnectButton.addEventListener('click', async () => {
    try {
      disconnectButton.disabled = true;
      const response = await fetch('{{ url_for("api_disconnect_device") }}', { method: 'POST' });
      if (!response.ok) throw new Error('Unable to disconnect the current device.');
      showAlert('Device disconnected. Configure a new one to continue.', 'info');
      disconnectButton.classList.add('d-none');
      lastTestSuccess = false;
      connectButton.disabled = true;
      resultCard.classList.add('d-none');
    } catch (error) {
      showAlert(error.message, 'danger');
    } finally {
      disconnectButton.disabled = false;
    }
  });

  refreshDevicesBtn.addEventListener('click', loadSavedDevices);

  document.addEventListener('DOMContentLoaded', () => {
    {% if devices %}
      renderDevices({{ devices|tojson }});
    {% endif %}
    loadCurrentConnection();
  });
</script>
{% endblock %}
